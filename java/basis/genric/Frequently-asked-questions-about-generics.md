---
title: 关于泛型的常见问题
mathjax: true
data: 2020-08-14 20:59:33
updated:
tags:
- 泛型
categories: 基础
---

## 前言

这里罗列一些关于泛型的常见问题,并给出解答。其中本篇大多数问题来自[Java Generics FAQs - Generic And Parameterized Types](http://www.angelikalanger.com/GenericsFAQ/FAQSections/ParameterizedTypes.html),我这里仅翻译一些我认为比较容易糊涂的问题。

当然,在解答这些问题时,我们需要牢记一个概念,通配符`?`表示不知道是什么类型,而不是任意类型。

## 使用通配符时经常出现的capture#XXX of ? 到底什么意思?

在使用通配符时,我们很有可能会遇到类似`capture#337 of ?`这样莫名奇妙的错误。其中`capture`是捕获的意思,捕获的是通配符`?`,那么`#337`又代表着什么?这一切都要从捕获转化(Capture Conversion)开始说起。

让我们思考一个问题,如果我们定义定义一个泛型类C(类似于List容器),那么调用这个泛型类的对象方法时,方法的签名是什么样的?像下面这样?

``` java
class C <? extends Number>{
    ...
    ? get();
    void add(?)
}
```
这显然是毫无意义的,但是我们直到实例化类时一定会使用一个具体的类型X\:\<Number(:<表示前者继承于后者),尽管我们不知道这个X到底是什么类型的。这并不重要。

那么被具体类型X实例化的类C长下面这样:

``` java
class C<X>{//X:<Number
    ...
    X get();
    void add(X);
}
```
使用一个具有名字的类型比使用通配符`?`容易多了。所以编译器也是这么做的。只不过编译器并不会使用`X`,而是随机使用一个数字,例如`#337`表示上面这个通配符。所以才会有了这句`capture#337 of ?`。即编译将遇到这个统配符`?`分配了一个名字叫做`#337`。

当一个对象的类型是通配符类型,编译器会使用类型变量替换**每一个**遇到的通配符`?`(类型变量中的数字按序增长),这种操作名为`capture conversion`,通过这个操作,编译器只需要处理带有具体类型的对象。

对于上面的例子,`get()`方法返回一个`X`类型的引用,其中`X:<Number`,那么我们就可以执行下述操作:
>Number n= c.get();//c为类C的实例

但是我们却不能向c中添加元素。

> c.add(number)

因为add方法接受的参数类型为x(编译器的名字可能为capture#1 of ?),而容器c中的引用至少都为Number类型,因为容器内的引用都有一个限制:`? extends Number`,所以编译器处于安全,将容器内的引用推断为`Number`类型肯定是不会错的。

那么一个存储`Number`类型的容器,能接受一个类型为`capture#1 of ?`的值吗?不知道,因为后者的类型编译器无法推断,所以为了保险起见,直接会产生编译错误。

## 为什么定义定义泛型类时不能使用通配符?



